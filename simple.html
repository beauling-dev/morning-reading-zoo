<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—©è¯»åŠ¨ç‰©å›­ - ç®€åŒ–ç‰ˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(to bottom, #e0f2fe, #dcfce7);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
            max-width: 800px;
            width: 100%;
        }
        h1 {
            text-align: center;
            color: #1e3a8a;
            font-size: 36px;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 30px;
        }
        .zoo {
            height: 400px;
            background: #aeeaff;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .grass {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: #98fb98;
        }
        .animal {
            position: absolute;
            font-size: 48px;
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: #f9fafb;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .card h3 {
            margin-top: 0;
            color: #374151;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button.stop {
            background: #ef4444;
        }
        button.stop:hover {
            background: #dc2626;
        }
        .decibel {
            font-size: 32px;
            font-weight: bold;
            color: #3b82f6;
        }
        .timer {
            font-size: 24px;
            color: #10b981;
            font-weight: bold;
        }
        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¦ æ—©è¯»åŠ¨ç‰©å›­ ğŸ¸</h1>
        <p class="subtitle">å¤§å£°æœ—è¯»å°åŠ¨ç‰©ä»¬æ‰ä¼šå‡ºç°ï¼Œå¿«ç‚¹å¤§å£°æœ—è¯»å§ï¼</p>

        <div id="status" style="padding: 10px; margin-bottom: 10px; background: #e0f2fe; border-radius: 5px; text-align: center; color: #0369a1;">
            å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹ç›‘æµ‹"æŒ‰é’®å¼€å§‹
        </div>

        <div class="zoo" id="zoo">
            <div class="grass"></div>
        </div>

        <div class="controls">
            <div class="card">
                <h3>ğŸ”Š å½“å‰åˆ†è´</h3>
                <div class="decibel" id="decibel">0 dB</div>
                <label>é˜ˆå€¼: <span id="thresholdValue">10</span> dB</label>
                <input type="range" id="threshold" min="5" max="50" value="10">
            </div>

            <div class="card">
                <h3>â±ï¸ æœ—è¯»æ—¶é—´</h3>
                <div class="timer" id="timer">00:00:00</div>
            </div>

            <div class="card">
                <h3>ğŸ® æ§åˆ¶</h3>
                <button id="startBtn" onclick="toggleMonitoring()">å¼€å§‹ç›‘æµ‹</button>
                <button id="resetBtn" onclick="resetZoo()">æ¸…ç©ºåŠ¨ç‰©å›­</button>
            </div>
        </div>
    </div>

    <script>
        let isMonitoring = false;
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let timerInterval = null;
        let elapsedTime = 0;
        let threshold = 10;
        let lastAnimalTime = 0;

        const animals = ['ğŸ¦', 'ğŸ·', 'ğŸ¸', 'ğŸ¼', 'ğŸ®', 'ğŸµ', 'ğŸ¦Š', 'ğŸ°', 'ğŸ¨', 'ğŸ¦„', 'ğŸ»', 'ğŸ¯'];
        const zoo = document.getElementById('zoo');
        const decibelDisplay = document.getElementById('decibel');
        const thresholdSlider = document.getElementById('threshold');
        const thresholdValue = document.getElementById('thresholdValue');
        const timerDisplay = document.getElementById('timer');
        const startBtn = document.getElementById('startBtn');
        const statusDiv = document.getElementById('status');

        thresholdSlider.addEventListener('input', (e) => {
            threshold = parseInt(e.target.value);
            thresholdValue.textContent = threshold;
        });

        function formatTime(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            const decimals = Math.floor((ms % 1000) / 100);
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${decimals}`;
        }

        function addAnimal() {
            const animal = animals[Math.floor(Math.random() * animals.length)];
            const div = document.createElement('div');
            div.className = 'animal';
            div.textContent = animal;
            div.style.left = Math.random() * 80 + 10 + '%';
            div.style.top = Math.random() * 60 + 10 + '%';
            div.style.animationDelay = Math.random() * 2 + 's';
            zoo.appendChild(div);
        }

        function resetZoo() {
            const animals = zoo.querySelectorAll('.animal');
            animals.forEach(a => a.remove());
        }

        async function startMonitoring() {
            try {
                updateStatus('æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...', 'info');

                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);

                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.8;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                microphone.connect(analyser);

                updateStatus('éº¦å…‹é£å·²è¿æ¥ï¼Œæ­£åœ¨ç›‘æµ‹...', 'success');

                timerInterval = setInterval(() => {
                    elapsedTime += 100;
                    timerDisplay.textContent = formatTime(elapsedTime);
                }, 100);

                function checkAudio() {
                    if (!isMonitoring) return;

                    analyser.getByteTimeDomainData(dataArray);

                    // è®¡ç®—éŸ³é‡ - ä½¿ç”¨æ”¹è¿›çš„ç®—æ³•
                    let sum = 0;
                    for (let i = 0; i < bufferLength; i++) {
                        // å°† 0-255 è½¬æ¢ä¸º -1 åˆ° 1 çš„èŒƒå›´
                        const normalized = (dataArray[i] - 128) / 128;
                        sum += normalized * normalized;
                    }
                    const rms = Math.sqrt(sum / bufferLength);

                    // è½¬æ¢ä¸ºåˆ†è´ - ä½¿ç”¨æ›´æ•æ„Ÿçš„å…¬å¼
                    const db = Math.round(Math.max(0, 20 * Math.log10(rms + 0.001) * 2 + 60));

                    decibelDisplay.textContent = db + ' dB';

                    const now = Date.now();
                    if (db > threshold && now - lastAnimalTime > 500) {
                        addAnimal();
                        lastAnimalTime = now;
                    }

                    requestAnimationFrame(checkAudio);
                }

                checkAudio();
                isMonitoring = true;
                startBtn.textContent = 'æš‚åœç›‘æµ‹';
                startBtn.classList.add('stop');
            } catch (err) {
                console.error('Error:', err);
                if (err.name === 'NotAllowedError') {
                    statusDiv.textContent = 'é”™è¯¯ï¼šéº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼è¯·ç‚¹å‡»æµè§ˆå™¨åœ°å€æ å·¦ä¾§çš„é”å›¾æ ‡ï¼Œå…è®¸è®¿é—®éº¦å…‹é£ã€‚';
                    statusDiv.style.background = '#fee2e2';
                    statusDiv.style.color = '#991b1b';
                } else if (err.name === 'NotFoundError') {
                    statusDiv.textContent = 'é”™è¯¯ï¼šæœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡ï¼è¯·ç¡®ä¿å·²è¿æ¥éº¦å…‹é£ã€‚';
                    statusDiv.style.background = '#fee2e2';
                    statusDiv.style.color = '#991b1b';
                } else {
                    statusDiv.textContent = `é”™è¯¯ï¼š${err.message}`;
                    statusDiv.style.background = '#fee2e2';
                    statusDiv.style.color = '#991b1b';
                }
            }
        }

        function stopMonitoring() {
            isMonitoring = false;
            if (timerInterval) clearInterval(timerInterval);
            if (microphone) microphone.disconnect();
            if (audioContext) audioContext.close();
            startBtn.textContent = 'å¼€å§‹ç›‘æµ‹';
            startBtn.classList.remove('stop');
            decibelDisplay.textContent = '0 dB';
        }

        function toggleMonitoring() {
            if (isMonitoring) {
                stopMonitoring();
            } else {
                startMonitoring();
            }
        }

        function updateStatus(message, type = 'info') {
            statusDiv.textContent = message;
            if (type === 'success') {
                statusDiv.style.background = '#d1fae5';
                statusDiv.style.color = '#065f46';
            } else if (type === 'error') {
                statusDiv.style.background = '#fee2e2';
                statusDiv.style.color = '#991b1b';
            } else {
                statusDiv.style.background = '#e0f2fe';
                statusDiv.style.color = '#0369a1';
            }
        }
    </script>
</body>
</html>