<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº¦å…‹é£æµ‹è¯• - æ—©è¯»åŠ¨ç‰©å›­</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f0f4f8;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        .volume-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        .volume-level {
            height: 100%;
            background: linear-gradient(to right, #4caf50, #8bc34a, #ffeb3b, #ff9800, #f44336);
            width: 0%;
            transition: width 0.1s;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .decibel-display {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            color: #333;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ éº¦å…‹é£æµ‹è¯•å·¥å…·</h1>

        <div id="status" class="status info">
            ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®æ¥æ£€æµ‹éº¦å…‹é£...
        </div>

        <button id="startBtn" class="btn-primary" onclick="startTest()">å¼€å§‹æµ‹è¯•</button>
        <button id="stopBtn" class="btn-danger" onclick="stopTest()" style="display:none;">åœæ­¢æµ‹è¯•</button>

        <div class="decibel-display" id="decibel">-- dB</div>

        <div class="volume-bar">
            <div class="volume-level" id="volumeBar"></div>
        </div>

        <h3>æµ‹è¯•è¯´æ˜ï¼š</h3>
        <ul>
            <li>ç‚¹å‡»"å¼€å§‹æµ‹è¯•"ä¼šè¯·æ±‚éº¦å…‹é£æƒé™</li>
            <li>å…è®¸æƒé™åï¼Œå¯¹ç€éº¦å…‹é£è¯´è¯æˆ–å‘å‡ºå£°éŸ³</li>
            <li>è§‚å¯Ÿåˆ†è´æ•°å€¼å’ŒéŸ³é‡æ¡çš„å˜åŒ–</li>
            <li>æ­£å¸¸è¯´è¯å£°éŸ³åº”è¯¥åœ¨ 30-60 dB ä¹‹é—´</li>
            <li>å¦‚æœä¸€ç›´æ˜¾ç¤º 0 dBï¼Œè¯´æ˜éº¦å…‹é£æ²¡æœ‰å·¥ä½œ</li>
        </ul>

        <h3>å¸¸è§é—®é¢˜ï¼š</h3>
        <ul>
            <li><strong>æ— æ³•è®¿é—®éº¦å…‹é£</strong>ï¼šæ£€æŸ¥æµè§ˆå™¨è®¾ç½®ï¼Œç¡®ä¿å·²æˆäºˆæƒé™</li>
            <li><strong>éº¦å…‹é£è¢«å ç”¨</strong>ï¼šå…³é—­å…¶ä»–å¯èƒ½ä½¿ç”¨éº¦å…‹é£çš„åº”ç”¨ï¼ˆå¦‚è§†é¢‘ä¼šè®®è½¯ä»¶ï¼‰</li>
            <li><strong>æ²¡æœ‰å£°éŸ³</strong>ï¼šæ£€æŸ¥ç³»ç»ŸéŸ³é‡å’Œéº¦å…‹é£è®¾ç½®</li>
            <li><strong>iOS è®¾å¤‡</strong>ï¼šå¿…é¡»åœ¨ Safari æµè§ˆå™¨ä¸­ä½¿ç”¨ï¼Œå…¶ä»–æµè§ˆå™¨ä¸æ”¯æŒ</li>
        </ul>
    </div>

    <script>
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let isRunning = false;
        let animationFrame = null;

        const statusDiv = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const decibelDiv = document.getElementById('decibel');
        const volumeBar = document.getElementById('volumeBar');

        function updateStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        async function startTest() {
            try {
                updateStatus('æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...', 'info');

                // è¯·æ±‚éº¦å…‹é£æƒé™
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });

                updateStatus('éº¦å…‹é£å·²è¿æ¥ï¼Œæ­£åœ¨åˆå§‹åŒ–...', 'success');

                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);

                // é…ç½®åˆ†æå™¨
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.8;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                // è¿æ¥éº¦å…‹é£
                microphone.connect(analyser);

                // å¼€å§‹æ£€æµ‹
                isRunning = true;
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';

                updateStatus('æ­£åœ¨æ£€æµ‹å£°éŸ³...è¯·å¯¹ç€éº¦å…‹é£è¯´è¯', 'success');

                function detectSound() {
                    if (!isRunning) return;

                    // è·å–æ—¶åŸŸæ•°æ®
                    analyser.getByteTimeDomainData(dataArray);

                    // è®¡ç®—éŸ³é‡
                    let sum = 0;
                    for (let i = 0; i < bufferLength; i++) {
                        const normalized = (dataArray[i] - 128) / 128;
                        sum += normalized * normalized;
                    }
                    const rms = Math.sqrt(sum / bufferLength);

                    // è½¬æ¢ä¸ºåˆ†è´
                    const db = Math.max(0, Math.round(20 * Math.log10(rms) + 90));

                    // æ›´æ–°æ˜¾ç¤º
                    decibelDiv.textContent = db + ' dB';
                    volumeBar.style.width = Math.min(100, db * 2) + '%';

                    // æ ¹æ®éŸ³é‡æ”¹å˜é¢œè‰²
                    if (db < 30) {
                        decibelDiv.style.color = '#666';
                    } else if (db < 60) {
                        decibelDiv.style.color = '#4caf50';
                    } else if (db < 80) {
                        decibelDiv.style.color = '#ff9800';
                    } else {
                        decibelDiv.style.color = '#f44336';
                    }

                    animationFrame = requestAnimationFrame(detectSound);
                }

                detectSound();

            } catch (error) {
                console.error('Error:', error);
                if (error.name === 'NotAllowedError') {
                    updateStatus('é”™è¯¯ï¼šéº¦å…‹é£æƒé™è¢«æ‹’ç»ã€‚è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®éº¦å…‹é£ã€‚', 'error');
                } else if (error.name === 'NotFoundError') {
                    updateStatus('é”™è¯¯ï¼šæœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡ã€‚è¯·ç¡®ä¿å·²è¿æ¥éº¦å…‹é£ã€‚', 'error');
                } else {
                    updateStatus(`é”™è¯¯ï¼š${error.message}`, 'error');
                }
            }
        }

        function stopTest() {
            isRunning = false;

            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }

            if (microphone) {
                microphone.disconnect();
                microphone.mediaStream.getTracks().forEach(track => track.stop());
            }

            if (audioContext) {
                audioContext.close();
            }

            decibelDiv.textContent = '-- dB';
            volumeBar.style.width = '0%';
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            updateStatus('æµ‹è¯•å·²åœæ­¢', 'info');
        }
    </script>
</body>
</html>