<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="æ—©è¯»åŠ¨ç‰©å›­ - ä¸€ä¸ªæœ‰è¶£çš„äº’åŠ¨æœ—è¯»åº”ç”¨ï¼Œé€šè¿‡å¤§å£°æœ—è¯»æ¥æ”¶é›†å¯çˆ±çš„å°åŠ¨ç‰©ï¼">
    <meta name="keywords" content="æ—©è¯»,æœ—è¯»,å„¿ç«¥æ•™è‚²,åŠ¨ç‰©å›­,äº’åŠ¨åº”ç”¨">
    <title>æ—©è¯»åŠ¨ç‰©å›­ - å¤§å£°æœ—è¯»æ”¶é›†å°åŠ¨ç‰©</title>

    <!-- React and Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- PWA Support -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi5a2m5LmL5Zy65Z2A566h55CGIiwic2hvcnRfbmFtZSI6IuWtpuS5iuecuuWdgCIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjQUVFYWZmIiwidGhlbWVfY29sb3IiOiIjMzc0MjUxIiwib3JpZW50YXRpb24iOiJwb3J0cmFpdCJ9">
    <meta name="theme-color" content="#AEEaff">

    <style>
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-30px) scale(1.1); }
        }
        .animal {
            position: absolute;
            font-size: 48px;
            animation: float 3s ease-in-out infinite;
            animation-delay: calc(var(--delay) * 1s);
            user-select: none;
            -webkit-user-select: none;
        }
        .animal.bounce {
            animation: bounce 1s ease-in-out;
        }
        /* Custom slider styles */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
        }
        input[type="range"]::-webkit-slider-track {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: #3b82f6;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            margin-top: -6px;
        }
        input[type="range"]::-moz-range-track {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
        }
        input[type="range"]::-moz-range-thumb {
            background: #3b82f6;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
    </style>
</head>
<body class="bg-gradient-to-b from-blue-100 to-green-50 min-h-screen flex items-center justify-center p-4">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        const { Volume2, Settings, Play, Pause, Timer } = lucide;

        // Animal emojis array
        const animals = ['ğŸ¦', 'ğŸ·', 'ğŸ¸', 'ğŸ¼', 'ğŸ®', 'ğŸµ', 'ğŸ¦Š', 'ğŸ°', 'ğŸ¨', 'ğŸ¦„', 'ğŸ»', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·'];

        function MorningReadingZoo() {
            // States
            const [isMonitoring, setIsMonitoring] = useState(false);
            const [currentDecibel, setCurrentDecibel] = useState(0);
            const [decibelThreshold, setDecibelThreshold] = useState(10);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [animalsInZoo, setAnimalsInZoo] = useState([]);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [hasPermission, setHasPermission] = useState(null);

            // Refs
            const audioContextRef = useRef(null);
            const analyserRef = useRef(null);
            const microphoneRef = useRef(null);
            const streamRef = useRef(null);
            const animationFrameRef = useRef(null);
            const timerIntervalRef = useRef(null);
            const lastAnimalTimeRef = useRef(0);

            // Format time to MM:SS:ms
            const formatTime = (milliseconds) => {
                const minutes = Math.floor(milliseconds / 60000);
                const seconds = Math.floor((milliseconds % 60000) / 1000);
                const ms = Math.floor((milliseconds % 1000) / 10);
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}:${ms.toString().padStart(2, '0')}`;
            };

            // Calculate decibels from audio data
            const calculateDecibels = (dataArray) => {
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    sum += dataArray[i] * dataArray[i];
                }
                const rms = Math.sqrt(sum / dataArray.length);
                const decibels = 20 * Math.log10(rms);
                return isFinite(decibels) ? Math.max(0, decibels + 100) : 0; // Normalize to positive values
            };

            // Check microphone permission
            const checkPermission = async () => {
                try {
                    const permission = await navigator.permissions.query({ name: 'microphone' });
                    setHasPermission(permission.state);
                    permission.addEventListener('change', () => {
                        setHasPermission(permission.state);
                    });
                } catch (error) {
                    // Some browsers don't support permission API
                    setHasPermission('prompt');
                }
            };

            // Start microphone monitoring
            const startMonitoring = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    streamRef.current = stream;

                    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                    analyserRef.current = audioContextRef.current.createAnalyser();
                    microphoneRef.current = audioContextRef.current.createMediaStreamSource(stream);

                    analyserRef.current.fftSize = 256;
                    const bufferLength = analyserRef.current.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);

                    microphoneRef.current.connect(analyserRef.current);

                    // Start timer
                    timerIntervalRef.current = setInterval(() => {
                        setElapsedTime(prev => prev + 100);
                    }, 100);

                    // Analyze audio
                    const analyze = () => {
                        if (!isMonitoring || !analyserRef.current) return;

                        analyserRef.current.getByteTimeDomainData(dataArray);
                        const decibels = calculateDecibels(dataArray);
                        setCurrentDecibel(Math.round(decibels));

                        // Add animal if threshold exceeded (with cooldown)
                        const now = Date.now();
                        if (decibels > decibelThreshold && now - lastAnimalTimeRef.current > 500) {
                            addAnimal();
                            lastAnimalTimeRef.current = now;
                        }

                        animationFrameRef.current = requestAnimationFrame(analyze);
                    };

                    analyze();
                    setIsMonitoring(true);
                    setHasPermission('granted');
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    if (error.name === 'NotAllowedError') {
                        setHasPermission('denied');
                        alert('è¯·å…è®¸ä½¿ç”¨éº¦å…‹é£ä»¥ä½¿ç”¨æ—©è¯»åŠ¨ç‰©å›­åŠŸèƒ½ï¼');
                    } else {
                        alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è®¾ç½®');
                    }
                }
            };

            // Stop microphone monitoring
            const stopMonitoring = () => {
                if (animationFrameRef.current) {
                    cancelAnimationFrame(animationFrameRef.current);
                }
                if (timerIntervalRef.current) {
                    clearInterval(timerIntervalRef.current);
                }
                if (microphoneRef.current) {
                    microphoneRef.current.disconnect();
                }
                if (streamRef.current) {
                    streamRef.current.getTracks().forEach(track => track.stop());
                }
                if (audioContextRef.current) {
                    audioContextRef.current.close();
                }
                setIsMonitoring(false);
                setCurrentDecibel(0);
            };

            // Add random animal to the zoo
            const addAnimal = useCallback(() => {
                const randomAnimal = animals[Math.floor(Math.random() * animals.length)];
                const newAnimal = {
                    id: Date.now() + Math.random(),
                    emoji: randomAnimal,
                    x: Math.random() * 80 + 10, // 10% to 90% of container width
                    y: Math.random() * 60 + 10,  // 10% to 70% of container height
                    delay: Math.random() * 2
                };
                setAnimalsInZoo(prev => [...prev, newAnimal]);

                // Remove old animals if too many
                setAnimalsInZoo(prev => {
                    if (prev.length > 20) {
                        return prev.slice(-20);
                    }
                    return prev;
                });
            }, []);

            // Toggle monitoring
            const toggleMonitoring = () => {
                if (isMonitoring) {
                    stopMonitoring();
                } else {
                    startMonitoring();
                }
            };

            // Check permission on mount
            useEffect(() => {
                checkPermission();
            }, []);

            // Clean up on unmount
            useEffect(() => {
                return () => {
                    if (isMonitoring) {
                        stopMonitoring();
                    }
                };
            }, []);

            return (
                <div className="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-4xl">
                    {/* Header */}
                    <div className="text-center mb-6">
                        <h1 className="text-4xl font-bold text-blue-900 mb-2">æ—©è¯»åŠ¨ç‰©å›­</h1>
                        <p className="text-gray-600">å¤§å£°æœ—è¯»å°åŠ¨ç‰©ä»¬æ‰ä¼šå‡ºç°ï¼Œå¿«ç‚¹å¤§å£°æœ—è¯»å§ï¼</p>
                    </div>

                    {/* Zoo Area */}
                    <div
                        className="relative h-96 rounded-2xl overflow-hidden mb-6"
                        style={{ backgroundColor: '#AEEaff' }}
                    >
                        {/* Sky */}
                        <div className="absolute inset-0">
                            {/* Animals */}
                            {animalsInZoo.map(animal => (
                                <div
                                    key={animal.id}
                                    className="animal"
                                    style={{
                                        left: `${animal.x}%`,
                                        top: `${animal.y}%`,
                                        '--delay': animal.delay
                                    }}
                                >
                                    {animal.emoji}
                                </div>
                            ))}

                            {/* Hint text when no animals */}
                            {animalsInZoo.length === 0 && (
                                <div className="absolute inset-0 flex items-center justify-center">
                                    <p className="text-blue-700 text-lg">å¤§å£°æœ—è¯»è®©å°åŠ¨ç‰©ä»¬å‡ºç°å§ï¼</p>
                                </div>
                            )}
                        </div>

                        {/* Grass */}
                        <div
                            className="absolute bottom-0 left-0 right-0 h-16"
                            style={{ backgroundColor: '#98FB98' }}
                        />
                    </div>

                    {/* Control Panel */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {/* Decibel Card */}
                        <div className="bg-white rounded-2xl shadow-lg p-4">
                            <div className="flex items-center mb-2">
                                <Volume2 className="text-blue-600 mr-2" size={20} />
                                <h3 className="text-gray-700 font-semibold">å½“å‰åˆ†è´</h3>
                            </div>
                            <div className="text-3xl font-bold text-blue-600 mb-3">
                                {currentDecibel} dB
                            </div>
                            <div>
                                <label className="text-sm text-gray-600 block mb-1">
                                    åˆ†è´é˜ˆå€¼: {decibelThreshold} dB
                                </label>
                                <input
                                    type="range"
                                    min="5"
                                    max="50"
                                    value={decibelThreshold}
                                    onChange={(e) => setDecibelThreshold(Number(e.target.value))}
                                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                                />
                            </div>
                        </div>

                        {/* Timer Card */}
                        <div className="bg-white rounded-2xl shadow-lg p-4">
                            <div className="flex items-center mb-2">
                                <Timer className="text-green-600 mr-2" size={20} />
                                <h3 className="text-gray-700 font-semibold">å¤§å£°æœ—è¯»æ—¶é—´</h3>
                            </div>
                            <div className="text-3xl font-bold text-green-600">
                                {formatTime(elapsedTime)}
                            </div>
                        </div>

                        {/* Actions Card */}
                        <div className="bg-white rounded-2xl shadow-lg p-4">
                            <div className="flex flex-col gap-2 h-full justify-center">
                                <button
                                    onClick={() => setIsSettingsOpen(true)}
                                    className="flex items-center justify-center px-4 py-2 border-2 border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 transition-colors"
                                >
                                    <Settings size={18} className="mr-2" />
                                    è®¾ç½®
                                </button>
                                <button
                                    onClick={toggleMonitoring}
                                    className={`flex items-center justify-center px-4 py-2 rounded-lg transition-colors ${
                                        isMonitoring
                                            ? 'bg-pink-600 hover:bg-pink-700 text-white'
                                            : 'bg-green-600 hover:bg-green-700 text-white'
                                    }`}
                                    disabled={hasPermission === 'denied'}
                                >
                                    {isMonitoring ? (
                                        <>
                                            <Pause size={18} className="mr-2" />
                                            æš‚åœç›‘æµ‹
                                        </>
                                    ) : (
                                        <>
                                            <Play size={18} className="mr-2" />
                                            å¼€å§‹ç›‘æµ‹
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Settings Modal */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-2xl p-6 max-w-md w-full">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">è®¾ç½®</h2>
                                <div className="mb-4">
                                    <label className="block text-gray-700 mb-2">åˆ†è´é˜ˆå€¼</label>
                                    <p className="text-sm text-gray-600 mb-2">è°ƒæ•´è§¦å‘åŠ¨ç‰©å‡ºç°çš„éŸ³é‡å¤§å°</p>
                                    <input
                                        type="range"
                                        min="5"
                                        max="50"
                                        value={decibelThreshold}
                                        onChange={(e) => setDecibelThreshold(Number(e.target.value))}
                                        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                                    />
                                    <div className="text-center text-gray-600 mt-1">{decibelThreshold} dB</div>
                                </div>
                                <button
                                    onClick={() => setIsSettingsOpen(false)}
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors"
                                >
                                    ç¡®å®š
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Permission denied message */}
                    {hasPermission === 'denied' && (
                        <div className="mt-4 p-4 bg-yellow-100 border border-yellow-400 rounded-lg">
                            <p className="text-yellow-800">
                                éº¦å…‹é£æƒé™è¢«æ‹’ç»ã€‚è¯·åˆ·æ–°é¡µé¢å¹¶å…è®¸ä½¿ç”¨éº¦å…‹é£ä»¥ä½¿ç”¨åº”ç”¨åŠŸèƒ½ã€‚
                            </p>
                        </div>
                    )}
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<MorningReadingZoo />, document.getElementById('root'));
    </script>
</body>
</html>